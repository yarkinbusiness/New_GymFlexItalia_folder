# ğŸ—ï¸ GymFlex Italia - Architecture Audit & Proposal

> **Document Version:** 1.0  
> **Date:** December 26, 2025  
> **Purpose:** Comprehensive audit of current architecture issues and proposed solutions

---

## ğŸ“‘ Table of Contents

1. [Executive Summary](#executive-summary)
2. [Architecture Fundamentals](#architecture-fundamentals)
3. [Current State Analysis](#current-state-analysis)
4. [Critical Issues](#critical-issues)
5. [High Priority Issues](#high-priority-issues)
6. [Medium Priority Issues](#medium-priority-issues)
7. [Low Priority Issues](#low-priority-issues)
8. [Proposed Architecture](#proposed-architecture)
9. [Implementation Files](#implementation-files)
10. [Migration Plan](#migration-plan)

---

## Executive Summary

This document outlines critical architectural issues found in the GymFlex Italia iOS application. The codebase lacks fundamental separation of concerns between network, data, and presentation layers. This results in:

- **Code Duplication:** ~750 lines of repeated networking code across services
- **Mock Data Chaos:** Two conflicting mock data sources
- **Security Vulnerability:** Auth tokens stored in UserDefaults (unencrypted)
- **Untestable Code:** No dependency injection, tight coupling everywhere
- **UI Bugs:** Custom tab bar breaks standard iOS navigation behavior

**Recommended Action:** Implement proper layered architecture before adding new features.

---

## Architecture Fundamentals

### How Mobile App Architecture Should Work

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                        ğŸ“± MOBILE APP ARCHITECTURE                           â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚                      ğŸ¨ PRESENTATION LAYER                            â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚   â”‚    Views    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  ViewModels â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚   States    â”‚      â”‚  â”‚
â”‚  â”‚   â”‚  (SwiftUI)  â”‚        â”‚  (@MainActor)â”‚        â”‚ (Published) â”‚      â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â”‚                                 â”‚                                     â”‚  â”‚
â”‚  â”‚   PURPOSE:                      â”‚                                     â”‚  â”‚
â”‚  â”‚   â€¢ Display data to user        â”‚                                     â”‚  â”‚
â”‚  â”‚   â€¢ Handle user interactions    â”‚                                     â”‚  â”‚
â”‚  â”‚   â€¢ Manage view state           â”‚                                     â”‚  â”‚
â”‚  â”‚   â€¢ NO business logic here      â”‚                                     â”‚  â”‚
â”‚  â”‚                                 â”‚                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚                       ğŸ›ï¸ DOMAIN LAYER                                 â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚   â”‚  Protocols  â”‚        â”‚   Models    â”‚        â”‚  Use Cases  â”‚      â”‚  â”‚
â”‚  â”‚   â”‚(Repositories)â”‚        â”‚  (Domain)   â”‚        â”‚ (Optional)  â”‚      â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â”‚          â”‚                                                            â”‚  â”‚
â”‚  â”‚   PURPOSE:                                                            â”‚  â”‚
â”‚  â”‚   â€¢ Define contracts (protocols)                                      â”‚  â”‚
â”‚  â”‚   â€¢ Pure domain models (no framework dependencies)                    â”‚  â”‚
â”‚  â”‚   â€¢ Business rules & validation                                       â”‚  â”‚
â”‚  â”‚   â€¢ Platform-independent logic                                        â”‚  â”‚
â”‚  â”‚          â”‚                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                                                               â”‚
â”‚             â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚                        ğŸ’¾ DATA LAYER                                  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚   â”‚                    Repository Implementations                â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                              â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â”‚   Remote    â”‚    â”‚    Mock     â”‚    â”‚    Cache    â”‚    â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â”‚ Repository  â”‚    â”‚ Repository  â”‚    â”‚ Repository  â”‚    â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â”‚
â”‚  â”‚   â”‚          â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚              â”‚                                                        â”‚  â”‚
â”‚  â”‚   PURPOSE:                                                            â”‚  â”‚
â”‚  â”‚   â€¢ Implement repository protocols                                    â”‚  â”‚
â”‚  â”‚   â€¢ Data source abstraction (API, DB, Cache)                          â”‚  â”‚
â”‚  â”‚   â€¢ DTO â†” Domain model mapping                                        â”‚  â”‚
â”‚  â”‚   â€¢ Handle data persistence                                           â”‚  â”‚
â”‚  â”‚              â”‚                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                                           â”‚
â”‚                 â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚                       ğŸŒ NETWORK LAYER                                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚   â”‚  APIClient  â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Endpoint   â”‚        â”‚   DTOs      â”‚      â”‚  â”‚
â”‚  â”‚   â”‚             â”‚        â”‚ Definitions â”‚        â”‚ (Codable)   â”‚      â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â”‚          â”‚                                                            â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                                     â”‚  â”‚
â”‚  â”‚   â”‚             â”‚                                                     â”‚  â”‚
â”‚  â”‚   â–¼             â–¼                                                     â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚  â”‚
â”‚  â”‚ â”‚  Token  â”‚ â”‚   Error     â”‚                                          â”‚  â”‚
â”‚  â”‚ â”‚ Manager â”‚ â”‚  Handling   â”‚                                          â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   PURPOSE:                                                            â”‚  â”‚
â”‚  â”‚   â€¢ Single point of HTTP communication                                â”‚  â”‚
â”‚  â”‚   â€¢ Authentication token management                                   â”‚  â”‚
â”‚  â”‚   â€¢ Request/Response logging                                          â”‚  â”‚
â”‚  â”‚   â€¢ Retry logic & error mapping                                       â”‚  â”‚
â”‚  â”‚   â€¢ Timeout & cancellation handling                                   â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚                       â˜ï¸ BACKEND (API)                                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚   â”‚                    REST / GraphQL API                        â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                              â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â€¢ Authentication endpoints                                 â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â€¢ Resource CRUD operations                                 â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â€¢ Business logic validation                                â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â€¢ Database operations                                      â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   â€¢ Third-party integrations                                 â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                              â”‚    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                         ğŸ“Š DATA FLOW EXAMPLE                                â”‚
â”‚                      "User taps 'Book Gym' button"                          â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   1ï¸âƒ£ USER INTERACTION                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  GymDetailView                                                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  Button("Book Now") {                                       â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      Task { await viewModel.bookGym() }                     â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  }                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                    â”‚
â”‚                                        â–¼                                    â”‚
â”‚   2ï¸âƒ£ VIEWMODEL PROCESSES                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  GymDetailViewModel                                                 â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  func bookGym() async {                                     â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      isLoading = true                  // Update UI state   â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      let booking = try await                                â”‚   â”‚   â”‚
â”‚   â”‚  â”‚          bookingRepository.create(...)  // Call repository  â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      self.booking = booking            // Store result      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      isLoading = false                                      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  }                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                    â”‚
â”‚                                        â–¼                                    â”‚
â”‚   3ï¸âƒ£ REPOSITORY ABSTRACTS DATA SOURCE                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  BookingRepositoryProtocol (interface)                              â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  protocol BookingRepositoryProtocol {                       â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      func create(gymId: String, ...) async throws -> Bookingâ”‚   â”‚   â”‚
â”‚   â”‚  â”‚  }                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                              â”‚                                      â”‚   â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚   â”‚              â–¼                               â–¼                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚   â”‚  â”‚ RemoteBookingRepo    â”‚      â”‚  MockBookingRepo     â”‚            â”‚   â”‚
â”‚   â”‚  â”‚ (Production)         â”‚      â”‚  (Testing/Preview)   â”‚            â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                    â”‚
â”‚                                        â–¼                                    â”‚
â”‚   4ï¸âƒ£ API CLIENT HANDLES HTTP                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  APIClient                                                          â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  func request<T>(_ endpoint: Endpoint) async throws -> T    â”‚   â”‚   â”‚
â”‚   â”‚  â”‚                                                             â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Builds URLRequest from Endpoint                          â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Injects Authorization header                             â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Executes with retry logic                                â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Maps HTTP errors to APIError                             â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Decodes JSON response                                    â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                    â”‚
â”‚                                        â–¼                                    â”‚
â”‚   5ï¸âƒ£ NETWORK REQUEST                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  HTTP Request                                                       â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  POST /api/v1/bookings                                      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  Authorization: Bearer eyJhbGciOiJIUzI1NiIs...               â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  Content-Type: application/json                             â”‚   â”‚   â”‚
â”‚   â”‚  â”‚                                                             â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  {                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    "gym_id": "gym_001",                                     â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    "start_time": "2025-12-26T10:00:00Z",                    â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    "duration": 60                                           â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  }                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                    â”‚
â”‚                                        â–¼                                    â”‚
â”‚   6ï¸âƒ£ BACKEND PROCESSES                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Backend API                                                        â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Validates JWT token                                      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Checks gym availability                                  â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Validates user wallet balance                            â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Creates booking in database                              â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Deducts wallet balance                                   â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Generates QR code                                        â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Returns booking object                                   â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                    â”‚
â”‚                                        â–¼                                    â”‚
â”‚   7ï¸âƒ£ RESPONSE FLOWS BACK                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  HTTP Response                                                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  200 OK                                                     â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  {                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    "id": "booking_12345",                                   â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    "gym_id": "gym_001",                                     â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    "status": "confirmed",                                   â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    "qr_code": "base64...",                                  â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    ...                                                      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  }                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                              â”‚                                      â”‚   â”‚
â”‚   â”‚                              â–¼                                      â”‚   â”‚
â”‚   â”‚  APIClient decodes â†’ Repository maps DTO â†’ ViewModel updates state  â”‚   â”‚
â”‚   â”‚                              â”‚                                      â”‚   â”‚
â”‚   â”‚                              â–¼                                      â”‚   â”‚
â”‚   â”‚  View re-renders with new booking data                              â”‚   â”‚
â”‚   â”‚                                                                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Layer Responsibilities Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                    ğŸ“‹ LAYER RESPONSIBILITIES                                â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                                                          â”‚
â”‚  PRESENTATION    â”‚  âœ… Display data                                         â”‚
â”‚  (Views/VM)      â”‚  âœ… Handle user input                                    â”‚
â”‚                  â”‚  âœ… Manage loading/error states                          â”‚
â”‚                  â”‚  âœ… Navigation                                           â”‚
â”‚                  â”‚  âŒ NO HTTP calls                                        â”‚
â”‚                  â”‚  âŒ NO business logic                                    â”‚
â”‚                  â”‚  âŒ NO direct data access                                â”‚
â”‚                  â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                                                          â”‚
â”‚  DOMAIN          â”‚  âœ… Define repository protocols                          â”‚
â”‚  (Protocols/     â”‚  âœ… Define domain models                                 â”‚
â”‚   Models)        â”‚  âœ… Business validation rules                            â”‚
â”‚                  â”‚  âŒ NO framework imports                                 â”‚
â”‚                  â”‚  âŒ NO implementation details                            â”‚
â”‚                  â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                                                          â”‚
â”‚  DATA            â”‚  âœ… Implement repository protocols                       â”‚
â”‚  (Repositories)  â”‚  âœ… Decide data source (API/Cache/Mock)                  â”‚
â”‚                  â”‚  âœ… Map DTOs to domain models                            â”‚
â”‚                  â”‚  âœ… Handle caching logic                                 â”‚
â”‚                  â”‚  âŒ NO UI knowledge                                      â”‚
â”‚                  â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                                                          â”‚
â”‚  NETWORK         â”‚  âœ… Execute HTTP requests                                â”‚
â”‚  (APIClient)     â”‚  âœ… Manage auth tokens                                   â”‚
â”‚                  â”‚  âœ… Handle retries & timeouts                            â”‚
â”‚                  â”‚  âœ… Log requests/responses                               â”‚
â”‚                  â”‚  âœ… Map HTTP errors                                      â”‚
â”‚                  â”‚  âŒ NO business logic                                    â”‚
â”‚                  â”‚  âŒ NO domain model knowledge                            â”‚
â”‚                  â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Current State Analysis

### Current Architecture (Problematic)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                        âš ï¸ CURRENT CHAOS                                     â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                          VIEWS                                     â”‚    â”‚
â”‚   â”‚   DashboardView, GymDiscoveryView, ProfileView, etc.              â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚   âš ï¸ Some views directly access services                          â”‚    â”‚
â”‚   â”‚   âš ï¸ Hardcoded placeholder data mixed in                          â”‚    â”‚
â”‚   â”‚   âš ï¸ Inconsistent navigation patterns                             â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        VIEWMODELS                                  â”‚    â”‚
â”‚   â”‚   DashboardViewModel, GymDiscoveryViewModel, etc.                 â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚   âš ï¸ Directly call service singletons                             â”‚    â”‚
â”‚   â”‚   âš ï¸ Can't inject dependencies for testing                        â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                         SERVICES                                   â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚   â”‚   â”‚AuthService â”‚  â”‚GymsService â”‚  â”‚BookingServ.â”‚  â”‚WalletServ. â”‚ â”‚    â”‚
â”‚   â”‚   â”‚            â”‚  â”‚            â”‚  â”‚            â”‚  â”‚            â”‚ â”‚    â”‚
â”‚   â”‚   â”‚â€¢ URLSessionâ”‚  â”‚â€¢ URLSessionâ”‚  â”‚â€¢ URLSessionâ”‚  â”‚â€¢ URLSessionâ”‚ â”‚    â”‚
â”‚   â”‚   â”‚â€¢ Mock logicâ”‚  â”‚â€¢ Mock logicâ”‚  â”‚â€¢ Mock logicâ”‚  â”‚â€¢ Mock logicâ”‚ â”‚    â”‚
â”‚   â”‚   â”‚â€¢ Token mgmtâ”‚  â”‚â€¢ Token mgmtâ”‚  â”‚â€¢ Token mgmtâ”‚  â”‚â€¢ Token mgmtâ”‚ â”‚    â”‚
â”‚   â”‚   â”‚â€¢ Decoding  â”‚  â”‚â€¢ Decoding  â”‚  â”‚â€¢ Decoding  â”‚  â”‚â€¢ Decoding  â”‚ â”‚    â”‚
â”‚   â”‚   â”‚â€¢ Errors    â”‚  â”‚â€¢ Errors    â”‚  â”‚â€¢ Errors    â”‚  â”‚â€¢ Errors    â”‚ â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚   âŒ MASSIVE CODE DUPLICATION (~750 lines repeated)               â”‚    â”‚
â”‚   â”‚   âŒ Mock logic interleaved with production code                   â”‚    â”‚
â”‚   â”‚   âŒ Each service has its own error enum                           â”‚    â”‚
â”‚   â”‚   âŒ Token accessed via UserDefaults (insecure)                    â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        MOCK DATA                                   â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚   â”‚   â”‚   MockData.swift    â”‚    â”‚ MockGymDataProvider.swiftâ”‚          â”‚    â”‚
â”‚   â”‚   â”‚   (4 sample gyms)   â”‚    â”‚ (15 different gyms!)    â”‚          â”‚    â”‚
â”‚   â”‚   â”‚   IDs: gym_001-004  â”‚    â”‚ IDs: gym_1-15           â”‚          â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚   âŒ TWO CONFLICTING DATA SOURCES                                  â”‚    â”‚
â”‚   â”‚   âŒ Different ID formats                                          â”‚    â”‚
â”‚   â”‚   âŒ No relationship between gyms and bookings                     â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Problems Quantified

| Issue | Count | Impact |
|-------|-------|--------|
| Duplicate URLSession setup | 6 services | Maintenance nightmare |
| `if AppConfig.API.useMocks` checks | 25+ places | Untestable code |
| Custom error enums | 6 different | Inconsistent handling |
| Mock data sources | 2 conflicting | Data confusion |
| Token in UserDefaults | 3 places | Security vulnerability |
| Hardcoded padding for tab bar | 5+ views | UI fragility |

---

## Critical Issues

### ğŸ”´ Issue #1: Custom Tab Bar Breaks Navigation

**Location:** `Views/Root/RootTabView.swift`

**Problem:** Custom `CustomTabBar` with `ZStack` overlay instead of native `TabView`:

```swift
// âŒ CURRENT BROKEN IMPLEMENTATION
ZStack {
    Group {
        switch tabManager.selectedTab {
        case .home: DashboardView()
        case .discover: GymDiscoveryView()
        // ...
        }
    }
    
    VStack {
        Spacer()
        CustomTabBar(selectedTab: $tabManager.selectedTab)  // Overlays content!
    }
    .ignoresSafeArea(edges: .bottom)
}
```

**Broken Behaviors:**
- âŒ Tab bar doesn't hide when pushing NavigationStack detail views
- âŒ Tapping active tab doesn't pop to root (standard iOS behavior)
- âŒ Hardcoded 34pt safe area doesn't adapt to all devices
- âŒ Content gets clipped behind tab bar

**Fix:** Use native `TabView` with styling:

```swift
// âœ… CORRECT IMPLEMENTATION
TabView(selection: $tabManager.selectedTab) {
    NavigationStack {
        DashboardView()
    }
    .tabItem { Label("Home", systemImage: "house.fill") }
    .tag(Tab.home)
    
    NavigationStack {
        GymDiscoveryView()
    }
    .tabItem { Label("Discover", systemImage: "safari.fill") }
    .tag(Tab.discover)
    
    // ... other tabs
}
.tint(AppColors.brand)
```

---

### ğŸ”´ Issue #2: Token Storage Security Vulnerability

**Location:** `Services/AuthService.swift` (Lines 279-292)

**Problem:** Authentication tokens stored in unencrypted UserDefaults:

```swift
// âŒ INSECURE - Anyone with device access can read this
func getStoredToken() -> String? {
    return UserDefaults.standard.string(forKey: "auth_token")
    // TODO: Migrate to Keychain for production  <-- This TODO has been ignored!
}

private func storeToken(_ token: String) {
    UserDefaults.standard.set(token, forKey: "auth_token")
}
```

**Risk:**
- Tokens visible in iTunes backup
- Accessible by other apps with same Team ID
- No encryption at rest

**Fix:** Use Keychain (see `TokenManager.swift` in implementation section)

---

### ğŸ”´ Issue #3: No Centralized Network Layer

**Problem:** Every service duplicates networking boilerplate:

```swift
// This pattern is copied 20+ times across 6 services:

let url = URL(string: "\(baseURL)/endpoint")!
var request = URLRequest(url: url)
request.httpMethod = "POST"
request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
request.setValue("application/json", forHTTPHeaderField: "Content-Type")
request.httpBody = try JSONSerialization.data(withJSONObject: body)

let (data, response) = try await URLSession.shared.data(for: request)

guard let httpResponse = response as? HTTPURLResponse,
      (200...299).contains(httpResponse.statusCode) else {
    throw SomeError.failed
}

let decoder = JSONDecoder()
decoder.dateDecodingStrategy = .iso8601
return try decoder.decode(SomeType.self, from: data)
```

**Issues:**
- ~750 lines of duplicated code
- No centralized retry logic
- No request logging for debugging
- No token refresh handling
- Inconsistent timeout handling

---

## High Priority Issues

### ğŸŸ  Issue #4: Duplicate Mock Data Sources

**Locations:**
- `Services/MockData.swift` - 4 sample gyms (IDs: `gym_001` to `gym_004`)
- `Services/MockGymDataProvider.swift` - 15 Rome gyms (IDs: `gym_1` to `gym_15`)

```swift
// MockData.swift
static let sampleGyms: [Gym] = [
    Gym(id: "gym_001", name: "Flex Gym Roma Termini", ...),
    Gym(id: "gym_002", name: "Urban Fitness Milano", ...),
    // 4 gyms total
]

// MockGymDataProvider.swift - COMPLETELY DIFFERENT DATA
func generateRomeGyms() -> [Gym] {
    // Returns 15 gyms with IDs like "gym_1", "gym_2"
    // Different names, different structure
}
```

**Consequence:**
- Bookings reference gym IDs that don't exist in gym list
- UI shows inconsistent data between screens
- Developer confusion about which to use

---

### ğŸŸ  Issue #5: Mock Logic Mixed Into Production Code

**Pattern found in every service:**

```swift
func createBooking(gymId: String, ...) async throws -> Booking {
    // ğŸ‘‡ This check appears 25+ times across the codebase
    if AppConfig.API.useMocks {
        try? await Task.sleep(nanoseconds: 1_000_000_000)
        // 30+ lines of mock logic
        return Booking(...)
    }
    
    // Real implementation below
    guard let token = authService.getStoredToken() else {
        throw BookingError.notAuthenticated
    }
    // ... actual API call
}
```

**Problems:**
- Can't unit test ViewModels without API calls
- Mock and production code tightly coupled
- Flag check overhead on every call
- Risk of shipping mock code in production

**Fix:** Protocol-based dependency injection (see proposed architecture)

---

### ğŸŸ  Issue #6: Inconsistent Navigation Patterns

| View | Navigation Approach |
|------|---------------------|
| `RootNavigationView` | Manual `Group` + `if/else` |
| `GymDiscoveryView` | `NavigationStack` |
| `DashboardView` | No navigation wrapper |
| `ProfileView` | No navigation wrapper |
| `AuthView` | No navigation wrapper |

**Problems:**
- No unified `NavigationPath` for deep linking
- Can't coordinate navigation across tabs
- Inconsistent back button behavior

---

## Medium Priority Issues

### ğŸŸ¡ Issue #7: Each Service Has Different Error Types

```swift
// 6 separate error enums with overlapping cases:

enum AuthError: LocalizedError {
    case invalidCredentials
    case notAuthenticated    // Duplicated
    case signUpFailed
    // ...
}

enum BookingError: LocalizedError {
    case notAuthenticated    // Duplicated
    case invalidURL          // Duplicated
    case createFailed
    // ...
}

enum WalletError: LocalizedError {
    case notAuthenticated    // Duplicated
    case invalidURL          // Duplicated
    case insufficientFunds
    // ...
}
```

**Fix:** Create unified `APIError` enum.

---

### ğŸŸ¡ Issue #8: Hardcoded Tab Bar Padding Everywhere

```swift
// Found in 5+ views:
.padding(.bottom, 100)  // Space for tab bar
```

**Locations:**
- `DashboardView.swift` line 45
- `ProfileView.swift` line 47
- `GymDiscoveryView.swift` line 145

**Problem:** If tab bar height changes, all views break.

---

### ğŸŸ¡ Issue #9: AppColors Are Dark-Mode Only

**Location:** `Design/AppStyle.swift`

```swift
// Hardcoded dark colors:
static let background = Color(red: 15/255, green: 15/255, blue: 16/255)
static let textHigh = Color.white

// But views also use system colors:
Color(.systemBackground)  // Adapts to light/dark
Color(.label)             // Adapts to light/dark
```

**Result:** Inconsistent appearance when switching color schemes.

---

### ğŸŸ¡ Issue #10: Components Defined Inside View Files

**Large view files with embedded private components:**

| File | Lines | Embedded Components |
|------|-------|---------------------|
| `AuthView.swift` | 319 | `PrimaryGradientButton`, `DividerRow`, `ErrorBanner`, `AuthSegmentedControl`, `GlowingOrb` |
| `DashboardView.swift` | 383 | `RecentActivityCard`, `QuickBookCard` |
| `GymDiscoveryView.swift` | 315 | `GymCard`, `AmenityChip` |
| `ProfileView.swift` | 533 | `InfoRow`, `BookingHistoryRow` |

**Problems:**
- Components marked `private` can't be reused
- Files are bloated and hard to navigate
- Duplicate card patterns across views

---

## Low Priority Issues

### ğŸ”µ Issue #11: Missing Loading & Empty States

Several views show hardcoded placeholder data instead of proper states:

```swift
// DashboardView.swift - Hardcoded fallback instead of loading state
if !viewModel.nearbyGyms.isEmpty {
    ForEach(viewModel.nearbyGyms) { gym in ... }
} else {
    // âŒ Hardcoded data shown as "fallback"
    NearbyGymCard(
        name: "MaxFit San Lorenzo",
        address: "Via dei Sardi 40, Rome",
        distance: "2 km",
        price: "â‚¬3/h",
        rating: 4.5
    )
}
```

---

### ğŸ”µ Issue #12: DateFormatter Created Inline

```swift
// Created fresh on every API call:
let dateFormatter = ISO8601DateFormatter()  // Found in 10+ places
```

**Fix:** Use shared static formatter.

---

### ğŸ”µ Issue #13: Preview Missing Environment Objects

```swift
// ProfileView.swift line 530
#Preview {
    ProfileView()  // âŒ Crashes - needs .environmentObject(AppearanceManager.shared)
}
```

---

## Proposed Architecture

### Folder Structure

```
Gym Flex Italia/
â”œâ”€â”€ App/
â”‚   â”œâ”€â”€ Gym_Flex_ItaliaApp.swift
â”‚   â””â”€â”€ DependencyContainer.swift      â† NEW
â”‚
â”œâ”€â”€ Core/
â”‚   â”œâ”€â”€ Network/
â”‚   â”‚   â”œâ”€â”€ APIClient.swift            â† NEW: Centralized networking
â”‚   â”‚   â”œâ”€â”€ APIError.swift             â† NEW: Unified error type
â”‚   â”‚   â”œâ”€â”€ Endpoint.swift             â† NEW: Type-safe endpoints
â”‚   â”‚   â”œâ”€â”€ HTTPMethod.swift           â† NEW
â”‚   â”‚   â”œâ”€â”€ NetworkLogger.swift        â† NEW
â”‚   â”‚   â””â”€â”€ TokenManager.swift         â† NEW: Keychain storage
â”‚   â”‚
â”‚   â”œâ”€â”€ Data/
â”‚   â”‚   â”œâ”€â”€ Repositories/
â”‚   â”‚   â”‚   â”œâ”€â”€ Remote/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RemoteGymRepository.swift
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RemoteBookingRepository.swift
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ RemoteAuthRepository.swift
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ Mock/
â”‚   â”‚   â”‚       â”œâ”€â”€ MockGymRepository.swift
â”‚   â”‚   â”‚       â”œâ”€â”€ MockBookingRepository.swift
â”‚   â”‚   â”‚       â””â”€â”€ MockAuthRepository.swift
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ DTOs/                      â† NEW: API response models
â”‚   â”‚   â”‚   â”œâ”€â”€ GymDTO.swift
â”‚   â”‚   â”‚   â””â”€â”€ BookingDTO.swift
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Mappers/                   â† NEW: DTO â†’ Domain
â”‚   â”‚       â””â”€â”€ GymMapper.swift
â”‚   â”‚
â”‚   â””â”€â”€ Domain/
â”‚       â”œâ”€â”€ Models/                    â† Existing, reorganized
â”‚       â”‚   â”œâ”€â”€ Gym.swift
â”‚       â”‚   â”œâ”€â”€ Booking.swift
â”‚       â”‚   â””â”€â”€ Profile.swift
â”‚       â”‚
â”‚       â””â”€â”€ Repositories/              â† NEW: Protocols
â”‚           â”œâ”€â”€ GymRepositoryProtocol.swift
â”‚           â””â”€â”€ BookingRepositoryProtocol.swift
â”‚
â”œâ”€â”€ Features/                          â† Reorganized by feature
â”‚   â”œâ”€â”€ Auth/
â”‚   â”œâ”€â”€ Dashboard/
â”‚   â”œâ”€â”€ Discovery/
â”‚   â””â”€â”€ Profile/
â”‚
â”œâ”€â”€ Shared/
â”‚   â”œâ”€â”€ Components/                    â† Extracted from views
â”‚   â”‚   â”œâ”€â”€ Cards/
â”‚   â”‚   â”œâ”€â”€ Inputs/
â”‚   â”‚   â””â”€â”€ Buttons/
â”‚   â””â”€â”€ MockData/                      â† Consolidated
â”‚       â””â”€â”€ MockData.swift
â”‚
â””â”€â”€ Resources/
```

### Dependency Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                    ğŸ”„ DEPENDENCY INJECTION FLOW                             â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   App Launch                                                                â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  DependencyContainer                                                â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  if AppConfig.API.useMocks {                                â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      gymRepository = MockGymRepository()                    â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      bookingRepository = MockBookingRepository()            â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  } else {                                                   â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      gymRepository = RemoteGymRepository(apiClient: ...)    â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      bookingRepository = RemoteBookingRepository(...)       â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  }                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚ Injects protocols, not concrete types                               â”‚
â”‚       â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ViewModels                                                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  class GymViewModel {                                       â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      private let gymRepository: GymRepositoryProtocol       â”‚   â”‚   â”‚
â”‚   â”‚  â”‚                                                             â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      init(gymRepository: GymRepositoryProtocol) {           â”‚   â”‚   â”‚
â”‚   â”‚  â”‚          self.gymRepository = gymRepository                 â”‚   â”‚   â”‚
â”‚   â”‚  â”‚      }                                                      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  }                                                          â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                                                                     â”‚   â”‚
â”‚   â”‚  âœ… ViewModel doesn't know if it's mock or real                    â”‚   â”‚
â”‚   â”‚  âœ… Easy to inject test doubles                                    â”‚   â”‚
â”‚   â”‚  âœ… No `if useMocks` checks anywhere                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Files

### File 1: `Core/Network/APIError.swift`

```swift
import Foundation

/// Unified error type for all API operations
enum APIError: LocalizedError {
    // Network errors
    case noConnection
    case timeout
    case serverError(statusCode: Int, message: String?)
    case invalidResponse
    
    // Auth errors
    case unauthorized
    case tokenExpired
    case invalidCredentials
    
    // Data errors
    case decodingFailed(Error)
    case encodingFailed(Error)
    case invalidURL
    
    // Business logic errors
    case notFound
    case validationFailed(String)
    case insufficientFunds
    case bookingConflict
    
    // Generic
    case unknown(Error)
    
    var errorDescription: String? {
        switch self {
        case .noConnection:
            return "No internet connection. Please check your network."
        case .timeout:
            return "Request timed out. Please try again."
        case .serverError(let code, let message):
            return message ?? "Server error (\(code))"
        case .invalidResponse:
            return "Invalid response from server"
        case .unauthorized:
            return "Session expired. Please sign in again."
        case .tokenExpired:
            return "Your session has expired"
        case .invalidCredentials:
            return "Invalid email or password"
        case .decodingFailed:
            return "Failed to process server response"
        case .encodingFailed:
            return "Failed to send request"
        case .invalidURL:
            return "Invalid request"
        case .notFound:
            return "Resource not found"
        case .validationFailed(let message):
            return message
        case .insufficientFunds:
            return "Insufficient wallet balance"
        case .bookingConflict:
            return "This time slot is no longer available"
        case .unknown(let error):
            return error.localizedDescription
        }
    }
    
    var isRetryable: Bool {
        switch self {
        case .noConnection, .timeout, .serverError(let code, _) where code >= 500:
            return true
        default:
            return false
        }
    }
}
```

---

### File 2: `Core/Network/Endpoint.swift`

```swift
import Foundation

/// Type-safe API endpoint definition
struct Endpoint {
    let path: String
    let method: HTTPMethod
    let headers: [String: String]?
    let queryItems: [URLQueryItem]?
    let body: Encodable?
    let requiresAuth: Bool
    
    init(
        path: String,
        method: HTTPMethod = .get,
        headers: [String: String]? = nil,
        queryItems: [URLQueryItem]? = nil,
        body: Encodable? = nil,
        requiresAuth: Bool = true
    ) {
        self.path = path
        self.method = method
        self.headers = headers
        self.queryItems = queryItems
        self.body = body
        self.requiresAuth = requiresAuth
    }
}

enum HTTPMethod: String {
    case get = "GET"
    case post = "POST"
    case put = "PUT"
    case patch = "PATCH"
    case delete = "DELETE"
}

// MARK: - Endpoint Definitions
extension Endpoint {
    
    // MARK: Auth
    static func signIn(email: String, password: String) -> Endpoint {
        Endpoint(
            path: "/auth/signin",
            method: .post,
            body: ["email": email, "password": password] as [String: String],
            requiresAuth: false
        )
    }
    
    static func signUp(email: String, password: String, fullName: String) -> Endpoint {
        Endpoint(
            path: "/auth/signup",
            method: .post,
            body: ["email": email, "password": password, "full_name": fullName] as [String: String],
            requiresAuth: false
        )
    }
    
    static var currentProfile: Endpoint {
        Endpoint(path: "/profile")
    }
    
    // MARK: Gyms
    static func gyms(
        latitude: Double? = nil,
        longitude: Double? = nil,
        radius: Double? = nil,
        limit: Int? = nil
    ) -> Endpoint {
        var queryItems: [URLQueryItem] = []
        if let lat = latitude { queryItems.append(.init(name: "latitude", value: String(lat))) }
        if let lon = longitude { queryItems.append(.init(name: "longitude", value: String(lon))) }
        if let r = radius { queryItems.append(.init(name: "radius", value: String(r))) }
        if let l = limit { queryItems.append(.init(name: "limit", value: String(l))) }
        
        return Endpoint(path: "/gyms", queryItems: queryItems.isEmpty ? nil : queryItems)
    }
    
    static func gym(id: String) -> Endpoint {
        Endpoint(path: "/gyms/\(id)")
    }
    
    // MARK: Bookings
    static func createBooking(gymId: String, startTime: String, duration: Int) -> Endpoint {
        Endpoint(
            path: "/bookings",
            method: .post,
            body: ["gym_id": gymId, "start_time": startTime, "duration": duration] as [String: Any]
        )
    }
    
    static func bookings(status: String? = nil) -> Endpoint {
        var queryItems: [URLQueryItem]? = nil
        if let status = status {
            queryItems = [.init(name: "status", value: status)]
        }
        return Endpoint(path: "/bookings", queryItems: queryItems)
    }
    
    // MARK: Wallet
    static var walletBalance: Endpoint {
        Endpoint(path: "/wallet/balance")
    }
}
```

---

### File 3: `Core/Network/TokenManager.swift`

```swift
import Foundation
import Security

/// Secure token storage using Keychain
final class TokenManager {
    
    static let shared = TokenManager()
    
    private let service = "com.gymflexitalia.auth"
    private let tokenKey = "access_token"
    
    private init() {}
    
    func getToken() -> String? {
        return read(key: tokenKey)
    }
    
    func saveToken(_ token: String) {
        save(key: tokenKey, value: token)
    }
    
    func clearToken() {
        delete(key: tokenKey)
    }
    
    var hasToken: Bool {
        getToken() != nil
    }
    
    // MARK: - Keychain Operations
    
    private func save(key: String, value: String) {
        guard let data = value.data(using: .utf8) else { return }
        
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrService as String: service,
            kSecAttrAccount as String: key
        ]
        
        SecItemDelete(query as CFDictionary)
        
        var newQuery = query
        newQuery[kSecValueData as String] = data
        newQuery[kSecAttrAccessible as String] = kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly
        
        SecItemAdd(newQuery as CFDictionary, nil)
    }
    
    private func read(key: String) -> String? {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrService as String: service,
            kSecAttrAccount as String: key,
            kSecReturnData as String: true,
            kSecMatchLimit as String: kSecMatchLimitOne
        ]
        
        var result: AnyObject?
        let status = SecItemCopyMatching(query as CFDictionary, &result)
        
        guard status == errSecSuccess,
              let data = result as? Data,
              let string = String(data: data, encoding: .utf8) else {
            return nil
        }
        return string
    }
    
    private func delete(key: String) {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrService as String: service,
            kSecAttrAccount as String: key
        ]
        SecItemDelete(query as CFDictionary)
    }
}
```

---

### File 4: `Core/Network/APIClient.swift`

```swift
import Foundation

/// Centralized API client for all network requests
final class APIClient {
    
    static let shared = APIClient()
    
    private let session: URLSession
    private let baseURL: URL
    private let tokenManager: TokenManager
    private let decoder: JSONDecoder
    private let encoder: JSONEncoder
    
    private init(
        baseURL: URL = URL(string: AppConfig.API.baseURL)!,
        tokenManager: TokenManager = .shared
    ) {
        self.baseURL = baseURL
        self.tokenManager = tokenManager
        
        let config = URLSessionConfiguration.default
        config.timeoutIntervalForRequest = AppConfig.API.timeout
        self.session = URLSession(configuration: config)
        
        self.decoder = JSONDecoder()
        self.decoder.dateDecodingStrategy = .iso8601
        self.decoder.keyDecodingStrategy = .convertFromSnakeCase
        
        self.encoder = JSONEncoder()
        self.encoder.dateEncodingStrategy = .iso8601
        self.encoder.keyEncodingStrategy = .convertToSnakeCase
    }
    
    func request<T: Decodable>(_ endpoint: Endpoint) async throws -> T {
        let request = try buildRequest(for: endpoint)
        
        #if DEBUG
        print("ğŸ“¤ \(endpoint.method.rawValue) \(request.url?.absoluteString ?? "")")
        #endif
        
        let (data, response) = try await executeWithRetry(request: request)
        
        #if DEBUG
        print("ğŸ“¥ Response: \(data.count) bytes")
        #endif
        
        try validateResponse(response)
        
        do {
            return try decoder.decode(T.self, from: data)
        } catch {
            throw APIError.decodingFailed(error)
        }
    }
    
    func requestVoid(_ endpoint: Endpoint) async throws {
        let request = try buildRequest(for: endpoint)
        let (_, response) = try await executeWithRetry(request: request)
        try validateResponse(response)
    }
    
    private func buildRequest(for endpoint: Endpoint) throws -> URLRequest {
        var components = URLComponents(
            url: baseURL.appendingPathComponent(endpoint.path),
            resolvingAgainstBaseURL: true
        )
        components?.queryItems = endpoint.queryItems
        
        guard let url = components?.url else {
            throw APIError.invalidURL
        }
        
        var request = URLRequest(url: url)
        request.httpMethod = endpoint.method.rawValue
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        
        if endpoint.requiresAuth, let token = tokenManager.getToken() {
            request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
        }
        
        endpoint.headers?.forEach { key, value in
            request.setValue(value, forHTTPHeaderField: key)
        }
        
        if let body = endpoint.body {
            request.httpBody = try encoder.encode(AnyEncodable(body))
        }
        
        return request
    }
    
    private func executeWithRetry(
        request: URLRequest,
        maxRetries: Int = 3
    ) async throws -> (Data, URLResponse) {
        var lastError: Error?
        
        for attempt in 0..<maxRetries {
            do {
                return try await session.data(for: request)
            } catch let error as URLError {
                lastError = error
                let apiError = mapURLError(error)
                
                guard apiError.isRetryable && attempt < maxRetries - 1 else {
                    throw apiError
                }
                
                let delay = pow(2.0, Double(attempt)) * 0.5
                try await Task.sleep(nanoseconds: UInt64(delay * 1_000_000_000))
            }
        }
        
        throw lastError ?? APIError.unknown(NSError(domain: "", code: -1))
    }
    
    private func validateResponse(_ response: URLResponse) throws {
        guard let httpResponse = response as? HTTPURLResponse else {
            throw APIError.invalidResponse
        }
        
        switch httpResponse.statusCode {
        case 200..<300: return
        case 401:
            tokenManager.clearToken()
            throw APIError.unauthorized
        case 404: throw APIError.notFound
        case 400..<500: throw APIError.validationFailed("Request failed")
        case 500..<600: throw APIError.serverError(statusCode: httpResponse.statusCode, message: nil)
        default: throw APIError.invalidResponse
        }
    }
    
    private func mapURLError(_ error: URLError) -> APIError {
        switch error.code {
        case .notConnectedToInternet, .networkConnectionLost: return .noConnection
        case .timedOut: return .timeout
        default: return .unknown(error)
        }
    }
}

private struct AnyEncodable: Encodable {
    private let encode: (Encoder) throws -> Void
    
    init(_ wrapped: Encodable) {
        self.encode = wrapped.encode
    }
    
    func encode(to encoder: Encoder) throws {
        try encode(encoder)
    }
}
```

---

### File 5: `Core/Domain/Repositories/GymRepositoryProtocol.swift`

```swift
import Foundation
import CoreLocation

/// Repository protocol for gym operations
protocol GymRepositoryProtocol {
    func fetchGyms(near location: CLLocationCoordinate2D?, radius: Double, limit: Int?) async throws -> [Gym]
    func fetchGym(id: String) async throws -> Gym
    func searchGyms(query: String, near location: CLLocationCoordinate2D?) async throws -> [Gym]
    func fetchAvailability(gymId: String, date: Date) async throws -> [AvailabilitySlot]
}
```

---

### File 6: `Core/Data/Repositories/Remote/RemoteGymRepository.swift`

```swift
import Foundation
import CoreLocation

final class RemoteGymRepository: GymRepositoryProtocol {
    
    private let apiClient: APIClient
    
    init(apiClient: APIClient = .shared) {
        self.apiClient = apiClient
    }
    
    func fetchGyms(near location: CLLocationCoordinate2D?, radius: Double, limit: Int?) async throws -> [Gym] {
        let endpoint = Endpoint.gyms(
            latitude: location?.latitude,
            longitude: location?.longitude,
            radius: radius,
            limit: limit
        )
        return try await apiClient.request(endpoint)
    }
    
    func fetchGym(id: String) async throws -> Gym {
        try await apiClient.request(.gym(id: id))
    }
    
    func searchGyms(query: String, near location: CLLocationCoordinate2D?) async throws -> [Gym] {
        var queryItems = [URLQueryItem(name: "q", value: query)]
        if let loc = location {
            queryItems.append(.init(name: "latitude", value: String(loc.latitude)))
            queryItems.append(.init(name: "longitude", value: String(loc.longitude)))
        }
        let endpoint = Endpoint(path: "/gyms/search", queryItems: queryItems)
        return try await apiClient.request(endpoint)
    }
    
    func fetchAvailability(gymId: String, date: Date) async throws -> [AvailabilitySlot] {
        let dateString = ISO8601DateFormatter.shared.string(from: date)
        let endpoint = Endpoint(
            path: "/gyms/\(gymId)/availability",
            queryItems: [.init(name: "date", value: dateString)]
        )
        return try await apiClient.request(endpoint)
    }
}

extension ISO8601DateFormatter {
    static let shared: ISO8601DateFormatter = {
        let formatter = ISO8601DateFormatter()
        return formatter
    }()
}
```

---

### File 7: `Core/Data/Repositories/Mock/MockGymRepository.swift`

```swift
import Foundation
import CoreLocation

final class MockGymRepository: GymRepositoryProtocol {
    
    var gymsToReturn: [Gym] = MockData.gyms
    var shouldFail: Bool = false
    var delay: TimeInterval = 0.5
    
    func fetchGyms(near location: CLLocationCoordinate2D?, radius: Double, limit: Int?) async throws -> [Gym] {
        try await simulateNetwork()
        
        var result = gymsToReturn
        
        if let location = location {
            result.sort { gym1, gym2 in
                let userLocation = CLLocation(latitude: location.latitude, longitude: location.longitude)
                return gym1.distance(from: userLocation) < gym2.distance(from: userLocation)
            }
        }
        
        if let limit = limit {
            result = Array(result.prefix(limit))
        }
        
        return result
    }
    
    func fetchGym(id: String) async throws -> Gym {
        try await simulateNetwork()
        guard let gym = gymsToReturn.first(where: { $0.id == id }) else {
            throw APIError.notFound
        }
        return gym
    }
    
    func searchGyms(query: String, near location: CLLocationCoordinate2D?) async throws -> [Gym] {
        try await simulateNetwork()
        return gymsToReturn.filter {
            $0.name.localizedCaseInsensitiveContains(query) ||
            $0.address.localizedCaseInsensitiveContains(query)
        }
    }
    
    func fetchAvailability(gymId: String, date: Date) async throws -> [AvailabilitySlot] {
        try await simulateNetwork()
        return MockData.generateAvailability(for: date, gymId: gymId)
    }
    
    private func simulateNetwork() async throws {
        if shouldFail { throw APIError.serverError(statusCode: 500, message: "Mock error") }
        try await Task.sleep(nanoseconds: UInt64(delay * 1_000_000_000))
    }
}
```

---

### File 8: `Shared/MockData/MockData.swift` (Consolidated)

```swift
import Foundation
import CoreLocation

/// Centralized mock data for previews and testing
enum MockData {
    
    // MARK: - Gyms
    static let gyms: [Gym] = [
        Gym(
            id: "gym_001",
            name: "Flex Gym Roma Termini",
            description: "Premium fitness center near Termini station",
            address: "Via Giovanni Giolitti 44",
            city: "Roma",
            region: "Lazio",
            postalCode: "00185",
            country: "Italy",
            latitude: 41.9009,
            longitude: 12.5020,
            pricePerHour: 8.50,
            currency: "EUR",
            coverImageURL: "https://images.unsplash.com/photo-1534438327276-14e5300c3a48",
            imageURLs: [],
            amenities: [.wifi, .showers, .lockers, .airConditioning],
            equipment: [.treadmills, .dumbbells, .barbells],
            workoutTypes: [.cardio, .strength],
            phoneNumber: "+39 06 12345678",
            email: "info@flexgymroma.it",
            website: "https://flexgymroma.it",
            openingHours: nil,
            rating: 4.8,
            reviewCount: 124,
            totalBookings: 1250,
            isActive: true,
            isVerified: true,
            createdAt: Date(),
            updatedAt: Date()
        ),
        Gym(
            id: "gym_002",
            name: "Urban Fitness Milano",
            description: "Modern industrial-style gym in Milan",
            address: "Corso Como 10",
            city: "Milano",
            region: "Lombardia",
            postalCode: "20154",
            country: "Italy",
            latitude: 45.4809,
            longitude: 9.1889,
            pricePerHour: 12.00,
            currency: "EUR",
            coverImageURL: "https://images.unsplash.com/photo-1517836357463-d25dfeac3438",
            imageURLs: [],
            amenities: [.wifi, .showers, .lockers, .sauna],
            equipment: [.kettlebells, .pullUpBar, .yogaMats],
            workoutTypes: [.yoga, .pilates],
            phoneNumber: nil,
            email: nil,
            website: nil,
            openingHours: nil,
            rating: 4.9,
            reviewCount: 89,
            totalBookings: 850,
            isActive: true,
            isVerified: true,
            createdAt: Date(),
            updatedAt: Date()
        ),
        Gym(
            id: "gym_003",
            name: "CrossFit Colosseum",
            description: "Hardcore CrossFit box for serious athletes",
            address: "Via del Colosseo 2",
            city: "Roma",
            region: "Lazio",
            postalCode: "00184",
            country: "Italy",
            latitude: 41.8902,
            longitude: 12.4922,
            pricePerHour: 15.00,
            currency: "EUR",
            coverImageURL: "https://images.unsplash.com/photo-1517963879466-e1b54ebd9930",
            imageURLs: [],
            amenities: [.showers, .lockers, .waterStation],
            equipment: [.rowingMachine, .barbells, .pullUpBar],
            workoutTypes: [.crossfit, .strength],
            phoneNumber: nil,
            email: nil,
            website: nil,
            openingHours: nil,
            rating: 4.7,
            reviewCount: 210,
            totalBookings: 3200,
            isActive: true,
            isVerified: true,
            createdAt: Date(),
            updatedAt: Date()
        )
    ]
    
    // MARK: - Profile
    static let profile = Profile(
        id: "user_001",
        email: "demo@gymflex.it",
        fullName: "Alessandro Rossi",
        phoneNumber: "+39 333 1234567",
        avatarURL: nil,
        dateOfBirth: nil,
        gender: .male,
        avatarLevel: 3,
        totalWorkouts: 15,
        currentStreak: 3,
        longestStreak: 7,
        avatarStyle: .athlete,
        fitnessGoals: [.buildMuscle],
        preferredWorkoutTypes: [.strength],
        walletBalance: 25.00,
        createdAt: Date(),
        updatedAt: Date(),
        lastWorkoutDate: Date().addingTimeInterval(-86400)
    )
    
    // MARK: - Bookings
    static var bookings: [Booking] {
        [
            Booking(
                id: "booking_001",
                userId: "user_001",
                gymId: "gym_001",
                gymName: gyms[0].name,
                gymAddress: gyms[0].address,
                gymCoverImageURL: gyms[0].coverImageURL,
                startTime: Date(),
                endTime: Date().addingTimeInterval(3600),
                duration: 60,
                pricePerHour: gyms[0].pricePerHour,
                totalPrice: gyms[0].pricePerHour,
                currency: "EUR",
                status: .confirmed,
                checkinCode: nil,
                checkinTime: nil,
                checkoutTime: nil,
                qrCodeData: "QR_booking_001",
                qrCodeExpiresAt: nil,
                createdAt: Date(),
                updatedAt: Date(),
                cancelledAt: nil,
                cancellationReason: nil
            )
        ]
    }
    
    // MARK: - Availability Generator
    static func generateAvailability(for date: Date, gymId: String) -> [AvailabilitySlot] {
        let calendar = Calendar.current
        let startOfDay = calendar.startOfDay(for: date)
        
        return (6...22).compactMap { hour in
            guard let slotStart = calendar.date(byAdding: .hour, value: hour, to: startOfDay),
                  let slotEnd = calendar.date(byAdding: .hour, value: 1, to: slotStart) else {
                return nil
            }
            
            return AvailabilitySlot(
                id: "\(gymId)_\(hour)",
                gymId: gymId,
                startTime: slotStart,
                endTime: slotEnd,
                isAvailable: Int.random(in: 0...10) > 2,
                bookedSlots: Int.random(in: 0...20),
                maxCapacity: 50
            )
        }
    }
}
```

---

### File 9: `App/DependencyContainer.swift`

```swift
import Foundation

/// Dependency injection container
@MainActor
final class DependencyContainer: ObservableObject {
    
    static let shared = DependencyContainer()
    
    // MARK: - Repositories
    let gymRepository: GymRepositoryProtocol
    let bookingRepository: BookingRepositoryProtocol
    let authRepository: AuthRepositoryProtocol
    
    private init() {
        if AppConfig.API.useMocks {
            self.gymRepository = MockGymRepository()
            self.bookingRepository = MockBookingRepository()
            self.authRepository = MockAuthRepository()
        } else {
            self.gymRepository = RemoteGymRepository()
            self.bookingRepository = RemoteBookingRepository()
            self.authRepository = RemoteAuthRepository()
        }
    }
    
    // For testing
    init(
        gymRepository: GymRepositoryProtocol,
        bookingRepository: BookingRepositoryProtocol,
        authRepository: AuthRepositoryProtocol
    ) {
        self.gymRepository = gymRepository
        self.bookingRepository = bookingRepository
        self.authRepository = authRepository
    }
}
```

---

## Migration Plan

### Phase 1: Foundation (Week 1)
| Step | Task | Effort | Blocks |
|------|------|--------|--------|
| 1.1 | Create `APIError.swift` | 30 min | All networking |
| 1.2 | Create `HTTPMethod.swift` | 10 min | Endpoint |
| 1.3 | Create `Endpoint.swift` | 1 hr | APIClient |
| 1.4 | Create `TokenManager.swift` | 1 hr | APIClient |
| 1.5 | Create `APIClient.swift` | 2 hr | Repositories |

### Phase 2: Data Layer (Week 2)
| Step | Task | Effort | Blocks |
|------|------|--------|--------|
| 2.1 | Create repository protocols | 1 hr | Implementations |
| 2.2 | Consolidate `MockData.swift` | 1 hr | Mock repos |
| 2.3 | Create mock repositories | 2 hr | ViewModels |
| 2.4 | Create remote repositories | 3 hr | Production |
| 2.5 | Create `DependencyContainer` | 30 min | ViewModels |

### Phase 3: Migration (Week 3)
| Step | Task | Effort | Blocks |
|------|------|--------|--------|
| 3.1 | Update ViewModels to use DI | 3 hr | - |
| 3.2 | Delete old services | 30 min | - |
| 3.3 | Fix tab bar with native TabView | 2 hr | - |
| 3.4 | Extract shared components | 2 hr | - |

### Phase 4: Cleanup (Week 4)
| Step | Task | Effort | Blocks |
|------|------|--------|--------|
| 4.1 | Remove hardcoded padding | 1 hr | - |
| 4.2 | Fix color inconsistencies | 1 hr | - |
| 4.3 | Add proper loading/empty states | 2 hr | - |
| 4.4 | Fix preview providers | 1 hr | - |

---

## Summary

### Before vs After

```
BEFORE                              AFTER
â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€
6 services with duplicated code  â†’  1 APIClient
2 conflicting mock data sources  â†’  1 consolidated MockData
25+ `if useMocks` checks         â†’  Protocol-based DI
Token in UserDefaults            â†’  Keychain storage
Custom broken TabBar             â†’  Native TabView
750 lines of duplicate code      â†’  ~200 lines shared
Untestable ViewModels            â†’  Fully testable
```

### Estimated Total Effort

- **Foundation + Data Layer:** ~12 hours
- **Migration:** ~8 hours  
- **Cleanup:** ~5 hours
- **Total:** ~25 hours (1 developer, 1 week)

---

*Document generated from codebase audit on December 26, 2025*

